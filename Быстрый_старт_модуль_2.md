Модуль 2 — это погружение в сердце контентной модели Битрикс и основу для кастомизации системы. 

### **Модуль 2. Инфоблоки. Использование API «1С-Битрикс»**

---

### **1. Понятие инфоблока**

**Информационный блок (Инфоблок)** — это, пожалуй, самый важный и фундаментальный модуль в «1С-Битрикс». Его можно представить как **умную, структурированную таблицу в базе данных**, предназначенную для хранения однотипных данных.

**Простая аналогия:** Представьте себе обычную таблицу Excel:
*   **Лист книги** — это сам *Информационный блок* (например, "Новости").
*   **Группы строк** — это *Разделы* инфоблока (например, "Экономика", "Спорт").
*   **Отдельные строки** — это *Элементы* инфоблока (например, конкретная новость "Компания X показала рост прибыли").
*   **Столбцы** — это *Свойства* инфоблока (например, "Источник новости", "Фотография", "Тэги").

**Для чего нужны инфоблоки?**
Для хранения любого повторяющегося контента: новости, статьи, товары, каталог продукции, вакансии, сотрудники, отзывы, баннеры и т.д.

**Ключевые сущности:**
*   **Тип инфоблока:** Группа для объединения нескольких инфоблоков (например, тип "Контент" может содержать инфоблоки "Новости", "Статьи", "Блог").
*   **Инфоблок:** Непосредственно контейнер для данных.
*   **Раздел:** Категория или папка для группировки элементов. Имеет древовидную структуру (разделы могут быть вложенными).
*   **Элемент:** Конкретная единица информации (одна новость, один товар).
*   **Свойство:** Дополнительные характеристики элемента или раздела.

---

### **2. Свойства инфоблока и его разделов**

**Свойства бывают двух уровней:**

1.  **Свойства элементов:** Характеристики, относящиеся к каждому элементу.
    *   **Примеры для элемента "Товар":** `Цвет`, `Размер`, `Производитель`, `Артикул`, `Хит продаж (флажок Yes/No)`.
    *   **Типы свойств:** Строка, число, файл, список, привязка к элементам других инфоблоков (это мощный инструмент для создания связей).

2.  **Свойства разделов:** Характеристики, относящиеся ко всему разделу в целом.
    *   **Примеры для раздела "Одежда":** `SEO-описание`, `Картинка для баннера`, `Менеджер, ответственный за раздел`.

**Где это настраивается?**
В Административном разделе: `Контент` -> `Информационные блоки` -> [Выбираем нужный инфоблок] -> `Свойства`.

---

### **3. Импорт-экспорт данных инфоблока**

Это механизмы для массового добавления или выгрузки данных.

*   **Импорт:**
    *   **Интерфейс:** `Контент` -> `Информационные блоки` -> [Выбираем инфоблок] -> кнопка `Импорт`.
    *   **Формат:** CSV-файл. Вы можете массово создавать/обновлять элементы, разделы, а также их свойства.
    *   **Сценарии использования:** Первоначальное наполнение каталога, ежедневное обновление цен и остатков из 1С, пакетное добавление новостей.

*   **Экспорт:**
    *   **Интерфейс:** Аналогично, кнопка `Экспорт`.
    *   **Цель:** Получить данные из инфоблока для анализа, обработки во внешней программе или для резервной копии структуры.

---

### **4. Введение в API системы «1С-Битрикс»**

**API (Application Programming Interface)** — это набор готовых классов, методов и функций, которые предоставляет Битрикс для взаимодействия с его ядром и данными извне.

**Зачем нужно API?**
Чтобы программно (с помощью PHP-кода) выполнять действия, которые обычно делаются через админку: получать список новостей, добавлять товар в корзину, создавать пользователя, обновлять свойства элемента.

**Где находится документация?**
Официальная документация на [dev.1c-bitrix.ru](https://dev.1c-bitrix.ru/) — ваш главный источник.

**Основные пространства имен (с появлением D7):**
*   `\Bitrix\Main\*` — общие функции (запросы, файлы, система).
*   `\Bitrix\Iblock\*` — работа с инфоблоками.
*   `\Bitrix\Catalog\*` — работа с торговым каталогом.
*   `\Bitrix\Sale\*` — работа с заказами и корзиной.

---

### **5. Использование основных функций API**

Рассмотрим на примере работы с инфоблоками.

**Старый стиль (CIBlockElement) — еще очень распространен:**
```php
<?php
// Подключаем модуль "Информационные блоки"
if (!CModule::IncludeModule("iblock")) {
    return;
}

// Получаем список элементов (новостей)
$res = CIBlockElement::GetList(
    ["DATE_ACTIVE_FROM" => "DESC"], // Сортировка по дате
    ["IBLOCK_ID" => 5, "ACTIVE" => "Y"], // Фильтр по ID инфоблока и активности
    false, // Группировка
    ["nPageSize" => 10], // Постраничная навигация
    ["ID", "NAME", "DATE_ACTIVE_FROM", "PREVIEW_TEXT"] // Выбираемые поля
);
while ($element = $res->GetNext()) {
    echo $element['NAME'] . '<br>';
}
?>
```

**Новый (D7) стиль — более современный и предпочтительный:**
```php
<?php
// Не нужно явно подключать модуль, если используется автозагрузка Composer
use Bitrix\Iblock\Elements\ElementObject; // Если используется "API элементов" нового UF

// Чаще используется через ElementTable
use Bitrix\Iblock\ElementTable;

$query = ElementTable::getList([
    'select' => ['ID', 'NAME', 'DATE_ACTIVE_FROM'],
    'filter' => ['=IBLOCK_ID' => 5, '=ACTIVE' => 'Y'],
    'order' => ['DATE_ACTIVE_FROM' => 'DESC'],
    'limit' => 10
]);
while ($element = $query->fetch()) {
    echo $element['NAME'] . '<br>';
}
?>
```

---

### **6. События и работа с ними**

**События (Events)** — это механизм, который позволяет выполнять ваш собственный код в момент, когда в системе происходит определенное действие.

**Типы событий:**
1.  **События модулей (Event Manager):** Срабатывают при вызове API-методов.
    *   `OnBeforeIBlockElementAdd` / `OnAfterIBlockElementAdd` — до/после добавления элемента.
    *   `OnBeforeIBlockElementUpdate` / `OnAfterIBlockElementUpdate` — до/после обновления элемента.
    *   `OnSaleOrderSaved` — после сохранения заказа.

2.  **Агенты:** Это запланированные события, которые выполняются по расписанию (например, раз в день).

**Как это используется?**
*   **Пример:** При добавлении нового товара (`OnAfterIBlockElementAdd`) автоматически отправить уведомление менеджеру.
*   **Пример:** Перед сохранением заказа (`OnSaleOrderSaved`) проверить наличие товара на складе.
*   **Пример:** Автоматически генерировать ЧПУ для элемента при его сохранении.

**Где регистрируются обработчики?**
В файле `/local/php_interface/init.php` (предпочтительно) или в `/bitrix/php_interface/init.php`.

**Пример кода:**
```php
<?php
// В файле /local/php_interface/init.php

use Bitrix\Main\EventManager;

$eventManager = EventManager::getInstance();

// Добавляем обработчик на событие "После добавления элемента инфоблока"
$eventManager->addEventHandler(
    "iblock",
    "OnAfterIBlockElementAdd",
    function (&$arFields) {
        if ($arFields["IBLOCK_ID"] == 5) { // Если это наш инфоблок "Новости"
            // Отправляем email-уведомление
            mail('admin@site.ru', 'Добавлена новость', 'Новая новость: ' . $arFields['NAME']);
        }
    }
);
?>
```

---

### **7. Пользовательская настройка форм редактирования элементов**

Иногда стандартной формы редактирования элемента инфоблока недостаточно.

**Задача:** Добавить свое поле, изменить логику сохранения, скрыть или показать поля в зависимости от других значений.

**Способы решения:**

1.  **Пользовательские свойства (Свойства инфоблока):** Самый простой способ. Вы просто добавляете новое свойство типа "Строка", "Файл" и т.д. Оно автоматически появится в форме редактирования.

2.  **События для модификации формы:**
    *   Событие `OnBuildIBlockElementForm` позволяет программно добавить свои HTML-поля в форму. (Устаревший, но рабочий способ).

3.  **Пользовательские поля (User Fields) для высоконагруженных проектов (D7):**
    *   В новых версиях для элементов, основанных на D7 (`Битрикс > API-интерфейсы > Конструктор API`), можно добавлять свои поля как пользовательские (UF). Это самый современный и правильный способ, интегрирующийся напрямую в ORM Битрикс.

**Примерная логика:**
Вы создаете кастомное поле "Дополнительный заголовок". С помощью событий `OnBeforeIBlockElementAdd` и `OnBeforeIBlockElementUpdate` вы можете валидировать его или обрабатывать его значение перед сохранением в базу.

Этот модуль превращает вас из простого пользователя админки в разработчика, способного гибко настраивать систему под любые бизнес-требования. Вы учитесь не только *хранить* данные в инфоблоках, но и *программно управлять* ими.
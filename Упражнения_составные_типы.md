# **Практические упражнения по работе с составным типом в БСП Демо 3.10**

## **Упражнение 1: Разыменование полей составного типа**

### **Цель:** Научиться работать с полями, которые могут содержать ссылки на разные типы объектов

```bsl
// В БСП часто используются составные типы, например, в регистрах
// Рассмотрим регистр накопления "ВзаиморасчетыПоКонтрагентам"

ВЫБРАТЬ
    Движения.СсылкаДокумента КАК ДокументСсылка,
    // Поле СсылкаДокумента имеет составной тип - может ссылаться на любой документ
    Движения.СсылкаДокумента.Дата КАК ДатаДокумента,
    // Разыменование работает, но нужно учитывать составной тип!
    Движения.СсылкаДокумента.Номер КАК НомерДокумента,
    Движения.СсылкаДокумента.Проведен КАК Проведен
ИЗ
    РегистрНакопления.ВзаиморасчетыПоКонтрагентам.Движения КАК Движения
ГДЕ
    Движения.СсылкаДокумента.Дата МЕЖДУ &НачалоПериода И &КонецПериода
    // Условие по разыменованному полю работает для ВСЕХ типов документов,
    // у которых есть поле "Дата"
```

**Комментарий к коду:**
- `СсылкаДокумента` - составное поле, может ссылаться на ЛЮБОЙ документ
- При разыменовании `.Дата` система автоматически определяет тип документа и берет дату
- Это удобно, но может быть медленно при больших объемах данных

---

## **Упражнение 2: Оптимизация через регистр сведений документов**

### **Цель:** Показать оптимизацию запросов с составными типами через предварительную обработку

```bsl
// ПРОБЛЕМА: Прямое разыменование составных типов медленное
// РЕШЕНИЕ: Использовать предварительную выборку с явным приведением типов

ВЫБРАТЬ
    Движения.СсылкаДокумента,
    Движения.Сумма,
    // Вместо разыменования составного типа используем ВЫРАЗИТЬ
    ВЫРАЗИТЬ(Движения.СсылкаДокумента КАК Документ.РеализацияТоваровУслуг).Дата КАК ДатаРеализации,
    ВЫРАЗИТЬ(Движения.СсылкаДокумента КАК Документ.ПоступлениеТоваровУслуг).Дата КАК ДатаПоступления,
    // Универсальный способ через представление
    ПРЕДСТАВЛЕНИЕ(Движения.СсылкаДокумента) КАК ДокументПредставление
ИЗ
    РегистрНакопления.ВзаиморасчетыПоКонтрагентам.Движения КАК Движения
ГДЕ
    // Оптимизация: фильтруем по конкретным типам документов
    Движения.СсылкаДокумента ССЫЛКА Документ.РеализацияТоваровУслуг
    ИЛИ Движения.СсылкаДокумента ССЫЛКА Документ.ПоступлениеТоваровУслуг
```

**Комментарий к оптимизации:**
- `ВЫРАЗИТЬ()` явно указывает тип, ускоряя выполнение
- Фильтрация `ССЫЛКА` уменьшает количество обрабатываемых записей
- Представление работает с любыми типами, но медленнее

---

## **Упражнение 3: Условия с разыменованием полей составного типа**

### **Цель:** Научиться писать эффективные условия для полей составного типа

```bsl
// ЗАДАЧА: Найти движения по конкретному контрагенту в реализации

ВЫБРАТЬ
    Движения.СсылкаДокумента,
    Движения.Сумма,
    ПРЕДСТАВЛЕНИЕ(Движения.СсылкаДокумента) КАК Документ,
    // Сложное разыменование через несколько полей
    ВЫРАЗИТЬ(Движения.СсылкаДокумента КАК Документ.РеализацияТоваровУслуг).Контрагент.Наименование КАК Контрагент
ИЗ
    РегистрНакопления.ВзаиморасчетыПоКонтрагентам.Движения КАК Движения
ГДЕ
    // УСЛОВИЕ 1: Фильтр по типу документа (обязательно для оптимизации!)
    Движения.СсылкаДокумента ССЫЛКА Документ.РеализацияТоваровУслуг
    
    // УСЛОВИЕ 2: Разыменование в условии WHERE
    И ВЫРАЗИТЬ(Движения.СсылкаДокумента КАК Документ.РеализацияТоваровУслуг).Контрагент = &ВыбранныйКонтрагент
    
    // УСЛОВИЕ 3: Дополнительные условия по разыменованным полям
    И ВЫРАЗИТЬ(Движения.СсылкаДокумента КАК Документ.РеализацияТоваровУслуг).Дата >= &НачалоПериода
    И ВЫРАЗИТЬ(Движения.СсылкаДокумента КАК Документ.РеализацияТоваровУслуг).Проведен = ИСТИНА
```

**Комментарий к условиям:**
- Всегда сначала фильтруйте по типу `ССЫЛКА`, затем по разыменованным полям
- Используйте `ВЫРАЗИТЬ` для явного указания типа в условиях
- Сложные цепочки разыменования лучше выносить в подзапросы

---

## **Упражнение 4: Условие "Поле В МассивИзРазныхТипов"**

### **Цель:** Научиться фильтровать данные по принадлежности к нескольким типам

```bsl
// ЗАДАЧА: Выбрать движения только по определенным типам документов

ВЫБРАТЬ
    Движения.СсылкаДокумента,
    Движения.Сумма,
    ТИП(Движения.СсылкаДокумента).Представление КАК ТипДокумента,
    ПРЕДСТАВЛЕНИЕ(Движения.СсылкаДокумента) КАК Документ
ИЗ
    РегистрНакопления.ВзаиморасчетыПоКонтрагентам.Движения КАК Движения
ГДЕ
    // СПОСОБ 1: Через оператор ИЛИ (простой, но не оптимальный)
    (Движения.СсылкаДокумента ССЫЛКА Документ.РеализацияТоваровУслуг
    ИЛИ Движения.СсылкаДокумента ССЫЛКА Документ.ПоступлениеТоваровУслуг
    ИЛИ Движения.СсылкаДокумента ССЫЛКА Документ.ВозвратТоваровОтПокупателя)
    
    // СПОСОБ 2: Через В с явным перечислением типов (более читаемый)
    И Движения.СсылкаДокумента В (
        ВЫБРАТЬ РазрешенныеТипы.Ссылка ИЗ &МассивТиповДокументов КАК РазрешенныеТипы
    )
```

**Продолжение с параметром:**

```bsl
// Объявляем параметр для массива типов
Параметры = Новый Структура;
МассивТипов = Новый Массив;
МассивТипов.Добавить(Тип("Документ.РеализацияТоваровУслуг"));
МассивТипов.Добавить(Тип("Документ.ПоступлениеТоваровУслуг"));
МассивТипов.Добавить(Тип("Документ.ВозвратТоваровОтПокупателя"));

Параметры.Вставить("МассивТиповДокументов", МассивТипов);
Параметры.Вставить("НачалоПериода", НачалоМесяца(ТекущаяДата()));
Параметры.Вставить("КонецПериода", КонецМесяца(ТекущаяДата()));

// Альтернативный запрос с использованием В и подзапроса
ВЫБРАТЬ
    Движения.СсылкаДокумента,
    Движения.Сумма,
    // Определяем тип документа и обрабатываем соответственно
    ВЫБОР
        КОГДА Движения.СсылкаДокумента ССЫЛКА Документ.РеализацияТоваровУслуг
            ТОГДА "Реализация"
        КОГДА Движения.СсылкаДокумента ССЫЛКА Документ.ПоступлениеТоваровУслуг
            ТОГДА "Поступление"
        КОГДА Движения.СсылкаДокумента ССЫЛКА Документ.ВозвратТоваровОтПокупателя
            ТОГДА "Возврат"
        ИНАЧЕ "Другой документ"
    КОНЕЦ КАК ТипОперации,
    
    // Разные варианты разыменования в зависимости от типа
    ВЫБОР
        КОГДА Движения.СсылкаДокумента ССЫЛКА Документ.РеализацияТоваровУслуг
            ТОГДА ВЫРАЗИТЬ(Движения.СсылкаДокумента КАК Документ.РеализацияТоваровУслуг).Контрагент.Наименование
        КОГДА Движения.СсылкаДокумента ССЫЛКА Документ.ПоступлениеТоваровУслуг  
            ТОГДА ВЫРАЗИТЬ(Движения.СсылкаДокумента КАК Документ.ПоступлениеТоваровУслуг).Контрагент.Наименование
        ИНАЧЕ "Неизвестно"
    КОНЕЦ КАК КонтрагентНаименование
    
ИЗ
    РегистрНакопления.ВзаиморасчетыПоКонтрагентам.Движения КАК Движения
ГДЕ
    Движения.СсылкаДокумента В (&МассивТиповДокументов)
    И Движения.Период МЕЖДУ &НачалоПериода И &КонецПериода
```

---

## **Упражнение 5: Комплексный пример с подзапросами**

### **Цель:** Показать продвинутые техники работы с составными типами

```bsl
// ЗАДАЧА: Анализ движений по разным типам документов с детализацией

ВЫБРАТЬ
    Документы.Ссылка,
    Документы.ТипДокумента,
    Документы.Представление,
    Документы.Контрагент,
    Взаиморасчеты.Сумма
ИЗ
    (ВЫБРАТЬ
        Реализация.Ссылка,
        "Реализация" КАК ТипДокумента,
        Реализация.Ссылка.Представление КАК Представление,
        Реализация.Контрагент.Наименование КАК Контрагент
    ИЗ
        Документ.РеализацияТоваровУслуг КАК Реализация
    
    ОБЪЕДИНИТЬ ВСЕ
    
    ВЫБРАТЬ  
        Поступление.Ссылка,
        "Поступление" КАК ТипДокумента,
        Поступление.Ссылка.Представление КАК Представление,
        Поступление.Контрагент.Наименование КАК Контрагент
    ИЗ
        Документ.ПоступлениеТоваровУслуг КАК Поступление
    ) КАК Документы
    
    ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ВзаиморасчетыПоКонтрагентам.Движения КАК Взаиморасчеты
    ПО Документы.Ссылка = Взаиморасчеты.СсылкаДокумента

ГДЕ
    Взаиморасчеты.Период МЕЖДУ &НачалоПериода И &КонецПериода
```

**Комментарий к комплексному примеру:**
- Используем `ОБЪЕДИНИТЬ ВСЕ` для работы с разными типами документов
- Каждый подзапрос работает с конкретным типом, что ускоряет выполнение
- В основном запросе работаем с уже подготовленными данными

---

## **Ключевые выводы по работе с составными типами:**

### **✅ Рекомендации:**
1. Всегда используйте `ВЫРАЗИТЬ` для явного указания типа
2. Фильтруйте сначала по типу (`ССЫЛКА`), затем по данным
3. Используйте `В` с массивом типов для сложных фильтров
4. Разбивайте сложные запросы на подзапросы

### **❌ Избегайте:**
1. Прямого разыменования без фильтрации по типу
2. Слишком длинных цепочек разыменования
3. Использования `ПРЕДСТАВЛЕНИЕ()` в условиях WHERE

### **📊 Производительность:**
- Составные типы без оптимизации: **Медленно**
- С явным приведением типов: **Быстро**  
- С предварительной фильтрацией: **Очень быстро**

Эти упражнения помогут эффективно работать с составными типами в реальных задачах БСП!
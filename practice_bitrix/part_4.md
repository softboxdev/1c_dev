---


## **Технологии. Автоматизация типовых процессов разработки**

Это руководство охватывает ключевые инструменты и методики, которые позволяют ускорить разработку, повысить её качество и автоматизировать рутинные задачи в «1С-Битрикс: Управление сайтом».

---

### **1. Принципы и способы отладки сайтов на «1С-Битрикс»**

Эффективная отладка — основа быстрой разработки. Вот основные принципы и инструменты.

#### **Принципы отладки:**
1.  **От общего к частному:** Сначала определите область проблемы (Frontend/Backend, модуль, компонент), затем ищите конкретную причину.
2.  **Логирование:** Всегда оставляйте следы выполнения кода.
3.  **Воспроизводимость:** Убедитесь, что ошибку можно воспроизвести стабильно.
4.  **Изоляция:** Отключайте сторонние модули и код, чтобы найти конфликт.

#### **Способы и инструменты отладки:**

**1. Встроенные инструменты Битрикс:**
*   **Профайлер (`/bitrix/admin/php_profiler.php`):**
    *   **Что это:** Мощный встроенный инструмент, показывающий время выполнения SQL-запросов, хуков, кеширования.
    *   **Как включить:** В `php_interface/after_connect_d7.php` добавить:
        ```php
        const BX_PROFILER = true;
        if (function_exists('profiler_init')) {
            profiler_init();
        }
        ```
    *   **Что искать:** Медленные SQL-запросы (N+1 проблема), время работы компонентов.

*   **Техническая информация в футере:**
    *   **Как включить:** Настройки > Настройки продукта > Настройки модулей > Главный модуль > Прочие > Показывать техническую информацию в футере сайта.
    *   **Что дает:** Быстрый просмотр времени генерации страницы, выполненных запросов, использованной памяти.

*   **Журнал событий (Админка > Сервис > Журнал событий):**
    *   **Что это:** Централизованное место для всех системных ошибок PHP, уведомлений от модулей.
    *   **Как использовать:** Настройте фильтры по типу (Ошибка, Предупреждение) и модулю.

**2. Файл отладки (debug file):**
Создайте файл `debug.php` в корне сайта для быстрого вывода данных.

```php
<?php
// debug.php
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");

$APPLICATION->SetTitle("Debug");

// Вывод массивов и объектов
echo "<pre>";
print_r($your_variable);
echo "</pre>";

// Быстрая проверка
CVarDumper::dump($your_variable, 10, true);

require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
```

**3. Отладка в IDE (PHPStorm + Xdebug):**
*   **Настройка Xdebug:** Установите расширение для PHP и настройте в `php.ini`.
*   **Точки останова:** Останавливайте выполнение кода и исследуйте переменные, стек вызовов.
*   **Пошаговое выполнение:** Идите по коду строка за строкой.

**4. Отладка JavaScript:**
*   **Консоль браузера (F12):** Для ошибок Frontend.
*   **`console.log()`:** Для трассировки выполнения скриптов.
*   **Debugger:** Используйте оператор `debugger;` в JS-коде для остановки в браузере.

---

### **2. Понятие о мастерах, создание и использование мастера**

**Мастер (Wizard)** в Битрикс — это пошаговый интерфейс для автоматизации сложных или часто повторяющихся задач настройки (например, установка сайта, настройка магазина, создание структуры разделов).

#### **Создание мастера:**

**1. Структура файлов:**
```
/local/modules/your.module/
    /install/
        /wizards/
            /your.wizard/          # Кодовое имя мастера
                /lang/ru/          # Языковые файлы
                    step1.php
                    step2.php
                /scripts/          # PHP-скрипты для каждого шага
                    step1.php
                    step2.php
                /styles/           # CSS-стили для интерфейса
                template.php       # Шаблон оформления
                .description.php   # Описание мастера
```

**2. Файл описания мастера (`.description.php`):**
```php
<?
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED!==true) die();

$arWizardDescription = [
    "NAME" => "Мастер настройки интернет-магазина", // Название
    "DESCRIPTION" => "Помогает настроить базовые параметры магазина", // Описание
    "VERSION" => "1.0.0", // Версия
    "START_TYPE" => "WINDOW", // Запуск в окне (WINDOW) или встроенный (PUBLIC_PAGE)
    "STEPS" => [ // Список шагов
        "Step1", 
        "Step2",
        "FinalStep"
    ],
];
?>
```

**3. Скрипт шага (`/scripts/step1.php`):**
```php
<?
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED!==true) die();

class Step1 extends CBaseWizardStep
{
    // Инициализация шага
    function InitStep()
    {
        $this->SetStepID("step1");
        $this->SetTitle("Шаг 1. Настройка каталога");
        $this->SetNextStep("step2");
        $this->SetPrevStep(""); // Пусто для первого шага
    }
    
    // Отображение формы
    function ShowStep()
    {
        $this->content .= '<label>Название магазина: </label>';
        $this->content .= '<input type="text" name="shop_name" value="'.htmlspecialchars($this->GetVar("shop_name")).'">';
    }
    
    // Обработка данных формы
    function OnPostForm()
    {
        $shopName = $_POST["shop_name"] ?? '';
        if (empty($shopName)) {
            $this->SetError("Введите название магазина!");
            return false;
        }
        
        $this->SetVar("shop_name", $shopName);
        return true;
    }
}
?>
```

**4. Запуск мастера:**
*   Через админку: Настройки > Настройки продукта > Мастера настроек
*   Программно: `/bitrix/admin/wizard_install.php?lang=ru&wizardName=your.module:your.wizard`

---

### **3. Типовые задачи разработчика сайта и их автоматизация**

#### **Типовые задачи:**
1.  Создание структуры разделов и элементов инфоблоков
2.  Настройка прав доступа
3.  Миграция данных между средами (dev/stage/prod)
4.  Настройка почтовых событий и шаблонов
5.  Обновление цен и остатков товаров
6.  Генерация тестовых данных

#### **Способы автоматизации:**

**1. Консольные команды (cli.php):**
Создавайте скрипты для выполнения в командной строке.

```php
<?php
// cli_example.php
require($_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/main/include/prolog_before.php');

// Пример: массовое обновление цен
CModule::IncludeModule('iblock');
$res = CIBlockElement::GetList([], ['IBLOCK_ID' => 2, 'ACTIVE' => 'Y']);
while ($element = $res->Fetch()) {
    $newPrice = rand(1000, 5000);
    CIBlockElement::SetPropertyValues($element['ID'], 2, $newPrice, 'PRICE');
    echo "Updated price for {$element['NAME']}: {$newPrice}\n";
}

require($_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/main/include/epilog_after.php');
```
**Запуск:** `php cli_example.php`

**2. Модули миграции:**
Используйте библиотеки вроде `bitrix-migrations` для версионирования изменений БД.

**3. Собственные модули с админ-интерфейсом:**
Создавайте страницы в админке для частых операций.

**4. Генераторы кода:**
Пишите скрипты для автоматического создания типовых компонентов, шаблонов, инфоблоков.

---

### **4. Понятие об агентах, обработка событий**

#### **Агенты**

**Агент** — это функция или метод, который выполняется по расписанию (например, каждые 5 минут, раз в день).

**Создание агента:**

```php
<?
// Регистрация агента в init.php или при установке модуля
CAgent::AddAgent(
    "MyAgentFunction();",        // Вызываемая функция
    "main",                      // Модуль (опционально)
    "N",                         // Повторяемость: Y - повторяемый, N - одноразовый
    60                           // Интервал в секундах (для повторяемых)
);

// Или через AddAgentAgent для большей гибкости
CAgent::AddAgentAgent(
    "\\My\\Namespace\\MyAgent::run();", // Статический метод класса
    "main",
    "N",
    3600,
    "",                          // Дата первой проверки
    "Y",                         // Активен
    "25.05.2024 10:00:00"        // Дата следующего выполнения
);

// Функция агента
function MyAgentFunction()
{
    // Выполняемые действия
    CModule::IncludeModule('iblock');
    // Например, отправка уведомлений, очистка кеша, обновление данных
    
    // Для повторяемого агента обязательно возвращаем свое имя
    return "MyAgentFunction();";
}
?>
```

**Типы агентов:**
*   **Повторяемые:** Выполняются регулярно по расписанию
*   **Одноразовые:** Выполняются один раз в указанное время

**Просмотр и управление:** Админка > Сервис > Агенты

#### **Обработка событий**

**События (Event Listener)** — это механизм, позволяющий вашему коду реагировать на системные события, не изменяя ядро системы.

**Регистрация обработчика событий:**

В файле `/local/php_interface/init.php`:

```php
<?
// Обработчик события после добавления элемента инфоблока
AddEventHandler("iblock", "OnAfterIBlockElementAdd", "MyOnAfterElementAdd");

function MyOnAfterElementAdd(&$arFields)
{
    if ($arFields["IBLOCK_ID"] == 2) { // Только для инфоблока с ID=2
        // Отправляем уведомление администратору
        CEvent::Send("NEW_ELEMENT_ADDED", "s1", [
            "EMAIL_TO" => "admin@site.com",
            "ELEMENT_NAME" => $arFields["NAME"],
            "ELEMENT_ID" => $arFields["ID"]
        ]);
    }
}

// Обработчик через анонимную функцию (PHP 5.3+)
AddEventHandler("main", "OnProlog", function() {
    // Код выполняется на каждом хите в прологе
    if (defined('ADMIN_SECTION')) {
        // Действия только в админке
    }
});
?>
```

**Популярные события:**
*   **OnBeforeProlog / OnProlog / OnEpilog** — События инициализации страницы
*   **OnBeforeUserAdd / OnAfterUserAdd** — События регистрации пользователя
*   **OnBeforeIBlockElementAdd / OnAfterIBlockElementAdd** — События работы с элементами инфоблоков
*   **OnSaleOrderSaved** — События работы с заказами

**Просмотр зарегистрированных обработчиков:** Настройки > Настройки продукта > Журнал событий > Вкладка "Обработчики событий"

---

### **Итог**

Автоматизация в Битрикс — это мощный инструмент для:
- **Ускорения разработки** через мастеры и генераторы кода
- **Повышения надежности** через систему событий и агентов
- **Эффективной отладки** через профессиональные инструменты мониторинга

Освоив эти технологии, вы переходите от решения рутинных задач к созданию масштабируемых и легко поддерживаемых проектов.
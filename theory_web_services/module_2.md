Подробно разберем создание и работу с Web-сервисами в 1С, включая передачу параметров, возврат данных и интеграцию.

## Создание Web-сервисов в 1С

### 1. Процесс создания Web-сервиса

**Шаг 1: Создание объекта метаданных**
- В конфигураторе: `Библиотека внешних компонент` → `WS-Сервисы`
- Создаем новый WS-Сервис

**Шаг 2: Настройка свойств сервиса**
```javascript
// Свойства WS-Сервиса
Имя: "СервисОбменДанными"
ПространствоИмен: "http://mycompany.com/ws"
ИмяВерсия: "v1"
```

**Шаг 3: Добавление операций**
- Для сервиса создаем операции (методы)
- Каждая операция имеет параметры и возвращаемое значение

### 2. Разработка модуля работы Web-сервиса

**Структура модуля WS-Сервиса:**

```bsl
// WS-Сервис: СервисОбменДанными

// Операция: ПолучитьКурсВалюты
Функция ПолучитьКурсВалюты(КодВалюты, ДатаКурса) Экспорт
    
    // Проверка параметров
    Если ПустаяСтрока(КодВалюты) Тогда
        ВызватьИсключение "Не указан код валюты";
    КонецЕсли;
    
    Если Не ЗначениеЗаполнено(ДатаКурса) Тогда
        ДатаКурса = ТекущаяДата();
    КонецЕсли;
    
    // Бизнес-логика
    КурсВалюты = НайтиКурсВалюты(КодВалюты, ДатаКурса);
    
    Если КурсВалюты = Неопределено Тогда
        ВызватьИсключение "Курс валюты не найден";
    КонецЕсли;
    
    Возврат КурсВалюты;
    
КонецФункции

// Операция: СоздатьЗаказ
Функция СоздатьЗаказ(ДанныеЗаказа) Экспорт
    
    // Валидация входящих данных
    Если ДанныеЗаказа = Неопределено Тогда
        ВызватьИсключение "Не переданы данные заказа";
    КонецЕсли;
    
    // Создание документа
    НовыйЗаказ = Документы.ЗаказПокупателя.СоздатьДокумент();
    ЗаполнитьДанныеЗаказа(НовыйЗаказ, ДанныеЗаказа);
    
    // Проведение и сохранение
    Попытка
        НовыйЗаказ.Записать();
        НовыйЗаказ.Провести();
        
        // Возврат результата
        Результат = Новый Структура;
        Результат.Вставить("Номер", НовыйЗаказ.Номер);
        Результат.Вставить("Дата", НовыйЗаказ.Дата);
        Результат.Вставить("УникальныйИдентификатор", НовыйЗаказ.УникальныйИдентификатор);
        Результат.Вставить("Статус", "Успешно");
        
    Исключение
        Результат = Новый Структура;
        Результат.Вставить("Статус", "Ошибка");
        Результат.Вставить("Ошибка", ОписаниеОшибки());
    КонецПопытки;
    
    Возврат Результат;
    
КонецФункции
```

### 3. Передача параметров Web-сервису

**Типы параметров и их передача:**

```bsl
// 1. Примитивные типы
Функция ПростойМетод(СтроковыйПараметр, ЧисловойПараметр, ДатаПараметр) Экспорт
    // Автоматическое преобразование типов
КонецФункции

// 2. Сложные структуры (XDTO)
Функция МетодСоСтруктурой(Данные) Экспорт
    // Данные - XDTO объект, соответствующий XSD схеме
КонецФункции

// 3. Массивы
Функция МетодСМассивом(Элементы) Экспорт
    // Элементы - Массив XDTO объектов
КонецФункции
```

**Пример XDTO-структуры для параметров:**

```bsl
// В модуле WS-Сервиса
Функция СоздатьЗаказПокупателя(ЗаказДанные) Экспорт
    
    // ЗаказДанные - XDTO объект типа ns:ЗаказТип
    // Преобразование XDTO в объекты 1С
    
    КонтрагентКод = ЗаказДанные.Контрагент.Код;
    ДатаЗаказа = ЗаказДанные.ДатаЗаказа;
    
    // Обработка массива товаров
    Товары = ЗаказДанные.Товары;
    Для Каждого Товар Из Товары Цикл
        НоменклатураКод = Товар.КодНоменклатуры;
        Количество = Товар.Количество;
        Цена = Товар.Цена;
    КонецЦикла;
    
КонецФункции
```

### 4. Возврат примитивных данных

```bsl
// 1. Возврат строки
Функция ПолучитьВерсиюСистемы() Экспорт
    Возврат "1.0.1";
КонецФункции

// 2. Возврат числа
Функция ПолучитьКоличествоЗаказов(ДатаНачала, ДатаОкончания) Экспорт
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |    КОЛИЧЕСТВО(ЗаказПокупателя.Ссылка) КАК Количество
    |ИЗ
    |    Документ.ЗаказПокупателя КАК ЗаказПокупателя
    |ГДЕ
    |    ЗаказПокупателя.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания";
    
    Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
    
    Результат = Запрос.Выполнить().Выбрать();
    Если Результат.Следующий() Тогда
        Возврат Результат.Количество;
    Иначе
        Возврат 0;
    КонецЕсли;
КонецФункции

// 3. Возврат даты
Функция ПолучитьТекущуюДатуСервера() Экспорт
    Возврат ТекущаяДатаСервера();
КонецФункции

// 4. Возврат булево значения
Функция ПроверитьСуществованиеКонтрагента(ИНН) Экспорт
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
    |    Контрагенты.Ссылка
    |ИЗ
    |    Справочник.Контрагенты КАК Контрагенты
    |ГДЕ
    |    Контрагенты.ИНН = &ИНН";
    
    Запрос.УстановитьПараметр("ИНН", ИНН);
    
    Возврат Не Запрос.Выполнить().Пустой();
КонецФункции
```

### 5. Возврат сложных структур

```bsl
// 1. Возврат данных справочника
Функция ПолучитьКонтрагентов(ДатаАктуальности) Экспорт
    
    Если Не ЗначениеЗаполнено(ДатаАктуальности) Тогда
        ДатаАктуальности = ТекущаяДата();
    КонецЕсли;
    
    МассивКонтрагентов = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |    Контрагенты.Ссылка,
    |    Контрагенты.Код,
    |    Контрагенты.Наименование,
    |    Контрагенты.ИНН,
    |    Контрагенты.КПП
    |ИЗ
    |    Справочник.Контрагенты КАК Контрагенты
    |ГДЕ
    |    Контрагенты.ЭтоГруппа = ЛОЖЬ";
    
    РезультатЗапроса = Запрос.Выполнить();
    Выборка = РезультатЗапроса.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        Контрагент = Новый Структура;
        Контрагент.Вставить("Код", Выборка.Код);
        Контрагент.Вставить("Наименование", Выборка.Наименование);
        Контрагент.Вставить("ИНН", Выборка.ИНН);
        Контрагент.Вставить("КПП", Выборка.КПП);
        Контрагент.Вставить("Ссылка", Выборка.Ссылка.УникальныйИдентификатор);
        
        МассивКонтрагентов.Добавить(Контрагент);
        
    КонецЦикла;
    
    Возврат МассивКонтрагентов;
    
КонецФункции

// 2. Возврат данных документа
Функция ПолучитьЗаказыПокупателя(ДатаНачала, ДатаОкончания) Экспорт
    
    МассивЗаказов = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |    Заказ.Ссылка,
    |    Заказ.Номер,
    |    Заказ.Дата,
    |    Заказ.Контрагент.Наименование КАК Контрагент,
    |    Заказ.СуммаДокумента,
    |    Заказ.Проведен
    |ИЗ
    |    Документ.ЗаказПокупателя КАК Заказ
    |ГДЕ
    |    Заказ.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания";
    
    Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
    
    РезультатЗапроса = Запрос.Выполнить();
    Выборка = РезультатЗапроса.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        Заказ = Новый Структура;
        Заказ.Вставить("Номер", Выборка.Номер);
        Заказ.Вставить("Дата", Выборка.Дата);
        Заказ.Вставить("Контрагент", Выборка.Контрагент);
        Заказ.Вставить("Сумма", Выборка.СуммаДокумента);
        Заказ.Вставить("Статус", ?(Выборка.Проведен, "Проведен", "Не проведен"));
        Заказ.Вставить("Ссылка", Выборка.Ссылка.УникальныйИдентификатор);
        
        // Получение табличной части
        Заказ.Вставить("Товары", ПолучитьТоварыЗаказа(Выборка.Ссылка));
        
        МассивЗаказов.Добавить(Заказ);
        
    КонецЦикла;
    
    Возврат МассивЗаказов;
    
КонецФункции

// Вспомогательная функция для получения табличной части
Функция ПолучитьТоварыЗаказа(СсылкаНаЗаказ)
    
    Товары = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |    Товары.Номенклатура.Наименование КАК Номенклатура,
    |    Товары.Количество,
    |    Товары.Цена,
    |    Товары.Сумма
    |ИЗ
    |    Документ.ЗаказПокупателя.Товары КАК Товары
    |ГДЕ
    |    Товары.Ссылка = &Ссылка";
    
    Запрос.УстановитьПараметр("Ссылка", СсылкаНаЗаказ);
    
    РезультатЗапроса = Запрос.Выполнить();
    Выборка = РезультатЗапроса.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        Товар = Новый Структура;
        Товар.Вставить("Номенклатура", Выборка.Номенклатура);
        Товар.Вставить("Количество", Выборка.Количество);
        Товар.Вставить("Цена", Выборка.Цена);
        Товар.Вставить("Сумма", Выборка.Сумма);
        
        Товары.Добавить(Товар);
    КонецЦикла;
    
    Возврат Товары;
    
КонецФункции
```

### 6. Интеграция с веб-приложениями

**Пример клиента на JavaScript:**

```javascript
class OneCWebServiceClient {
    constructor(serviceUrl) {
        this.serviceUrl = serviceUrl;
    }

    // Вызов метода получения контрагентов
    async getCounterparts(date) {
        const soapRequest = this.createSoapRequest(
            'ПолучитьКонтрагентов',
            {ДатаАктуальности: date}
        );

        try {
            const response = await fetch(this.serviceUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/soap+xml; charset=utf-8',
                },
                body: soapRequest
            });

            const xmlResponse = await response.text();
            return this.parseSoapResponse(xmlResponse);
        } catch (error) {
            console.error('SOAP Request failed:', error);
            throw error;
        }
    }

    // Создание SOAP запроса
    createSoapRequest(methodName, parameters) {
        return `<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/"
               xmlns:ws="http://mycompany.com/ws">
    <soap:Body>
        <ws:${methodName}>
            ${this.createParametersXml(parameters)}
        </ws:${methodName}>
    </soap:Body>
</soap:Envelope>`;
    }

    createParametersXml(parameters) {
        let xml = '';
        for (const [key, value] of Object.entries(parameters)) {
            xml += `<ws:${key}>${value}</ws:${key}>`;
        }
        return xml;
    }

    // Парсинг SOAP ответа
    parseSoapResponse(xmlResponse) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlResponse, "text/xml");
        
        // Извлечение данных из SOAP Response
        const resultElement = xmlDoc.getElementsByTagName('return')[0];
        if (resultElement) {
            return JSON.parse(resultElement.textContent);
        }
        
        throw new Error('Invalid SOAP response');
    }
}

// Использование клиента
const client = new OneCWebServiceClient('http://server/ws/СервисОбменДанными?wsdl');

// Получение контрагентов
client.getCounterparts('2024-01-15')
    .then(counterparts => {
        console.log('Контрагенты:', counterparts);
        // Отображение в интерфейсе
        this.displayCounterparts(counterparts);
    })
    .catch(error => {
        console.error('Ошибка:', error);
        this.showError(error.message);
    });
```

**Интеграция с React/Vue приложением:**

```javascript
// React компонент для работы с 1С Web-сервисом
import React, { useState, useEffect } from 'react';

const CounterpartList = () => {
    const [counterparts, setCounterparts] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    const fetchCounterparts = async (date) => {
        setLoading(true);
        setError(null);
        
        try {
            const response = await fetch('/api/counterparts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ date })
            });
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const data = await response.json();
            setCounterparts(data);
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchCounterparts(new Date().toISOString().split('T')[0]);
    }, []);

    if (loading) return <div>Загрузка...</div>;
    if (error) return <div>Ошибка: {error}</div>;

    return (
        <div>
            <h2>Список контрагентов</h2>
            <table>
                <thead>
                    <tr>
                        <th>Код</th>
                        <th>Наименование</th>
                        <th>ИНН</th>
                        <th>КПП</th>
                    </tr>
                </thead>
                <tbody>
                    {counterparts.map(counterpart => (
                        <tr key={counterpart.Ссылка}>
                            <td>{counterpart.Код}</td>
                            <td>{counterpart.Наименование}</td>
                            <td>{counterpart.ИНН}</td>
                            <td>{counterpart.КПП}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
};

export default CounterpartList;
```

**Node.js сервер-прокси для интеграции:**

```javascript
const express = require('express');
const soap = require('soap');
const app = express();

app.use(express.json());

// Прокси-эндпоинт для работы с 1С Web-сервисом
app.post('/api/counterparts', async (req, res) => {
    try {
        const { date } = req.body;
        
        // Создание SOAP клиента
        const wsdlUrl = 'http://1c-server/ws/СервисОбменДанными?wsdl';
        const client = await soap.createClientAsync(wsdlUrl);
        
        // Вызов метода 1С
        const result = await client.ПолучитьКонтрагентовAsync({
            ДатаАктуальности: date
        });
        
        // Преобразование ответа в JSON
        const counterparts = result[0].return;
        res.json(counterparts);
        
    } catch (error) {
        console.error('Integration error:', error);
        res.status(500).json({ 
            error: 'Internal server error',
            details: error.message 
        });
    }
});

// Эндпоинт для создания заказа
app.post('/api/orders', async (req, res) => {
    try {
        const orderData = req.body;
        
        const wsdlUrl = 'http://1c-server/ws/СервисОбменДанными?wsdl';
        const client = await soap.createClientAsync(wsdlUrl);
        
        const result = await client.СоздатьЗаказПокупателяAsync({
            ЗаказДанные: orderData
        });
        
        res.json(result[0].return);
        
    } catch (error) {
        console.error('Order creation error:', error);
        res.status(500).json({ 
            error: 'Failed to create order',
            details: error.message 
        });
    }
});

app.listen(3000, () => {
    console.log('Proxy server running on port 3000');
});
```

### Ключевые преимущества такой архитектуры:

1. **Изоляция** - веб-приложение не зависит от внутренней структуры 1С
2. **Безопасность** - прокси-сервер может выполнять дополнительную валидацию
3. **Кэширование** - промежуточный сервер может кэшировать часто запрашиваемые данные
4. **Масштабируемость** - легко добавить балансировку нагрузки
5. **Поддержка** - упрощается отладка и мониторинг обмена данными
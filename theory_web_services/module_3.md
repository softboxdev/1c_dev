# Руководство по созданию и применению HTTP сервисов в 1С

## 1. Введение в HTTP сервисы

### Что такое HTTP сервисы?
HTTP сервисы в 1С - это механизм для создания REST-like API, который позволяет внешним системам взаимодействовать с 1С по протоколу HTTP/HTTPS.

### Отличие от SOAP веб-сервисов:
- **SOAP**: Использует XML, сложная структура, строгая типизация
- **HTTP сервисы**: Проще, REST-подобные, JSON/XML, гибкие

### Типы авторизации:

#### Анонимная авторизация
```bsl
// Настройка в конфигураторе
// Сервис доступен без авторизации
```

#### Явная авторизация
```bsl
// Требует логин/пароль пользователя 1С
// Более безопасный способ
```

## 2. Создание базового HTTP сервиса

### Шаг 1: Создание обработки для HTTP сервиса

```bsl
// Обработка "HTTPСервисДемо"
// Установите флаг "Содержит HTTP сервисы"

// В свойствах обработки укажите:
// - Префикс URL: /demo
// - Проверка прав: Да/Нет
```

### Шаг 2: Добавление методов сервиса

## 3. Метод GET

### Создание метода GET

```bsl
&ВместоHTTPСервиса
Функция ПолучитьДанныеКонтрагента(Идентификатор, КлючСессии) Экспорт
    
    // Проверка авторизации (для явной авторизации)
    Если Не ПроверитьАвторизацию(КлючСессии) Тогда
        Возврат Новый Структура("Ошибка", "Не авторизован");
    КонецЕсли;
    
    Попытка
        // Поиск контрагента
        Контрагент = Справочники.Контрагенты.НайтиПоКоду(Идентификатор);
        Если Контрагент.Пустая() Тогда
            Возврат Новый Структура("Ошибка", "Контрагент не найден");
        КонецЕсли;
        
        // Формирование ответа
        Ответ = Новый Структура;
        Ответ.Вставить("Код", Контрагент.Код);
        Ответ.Вставить("Наименование", Контрагент.Наименование);
        Ответ.Вставить("ИНН", Контрагент.ИНН);
        Ответ.Вставить("Активен", НЕ Контрагент.ПомеченНаУдаление);
        
        Возврат Ответ;
        
    Исключение
        Возврат Новый Структура("Ошибка", ОписаниеОшибки());
    КонецПопытки;
    
КонецФункции
```

### Тестирование GET метода в Postman

```
GET http://localhost/hs/demo/ПолучитьДанныеКонтрагента?Идентификатор=00001&КлючСессии=abc123
```

## 4. Метод POST

### Создание метода POST

```bsl
&ВместоHTTPСервиса
Функция СоздатьНовогоКонтрагента(Данные, КлючСессии) Экспорт
    
    // Проверка авторизации
    Если Не ПроверитьАвторизацию(КлючСессии) Тогда
        Возврат Новый Структура("Ошибка", "Не авторизован");
    КонецЕсли;
    
    Попытка
        // Создание нового контрагента
        НовыйКонтрагент = Справочники.Контрагенты.СоздатьЭлемент();
        НовыйКонтрагент.Наименование = Данные.Наименование;
        НовыйКонтрагент.ИНН = Данные.ИНН;
        НовыйКонтрагент.КПП = Данные.КПП;
        
        // Запись в базу
        НовыйКонтрагент.Записать();
        
        // Ответ об успехе
        Ответ = Новый Структура;
        Ответ.Вставить("Успех", Истина);
        Ответ.Вставить("Код", НовыйКонтрагент.Код);
        Ответ.Вставить("УникальныйИдентификатор", НовыйКонтрагент.УникальныйИдентификатор());
        Ответ.Вставить("Сообщение", "Контрагент успешно создан");
        
        Возврат Ответ;
        
    Исключение
        Возврат Новый Структура("Успех", Ложь, "Ошибка", ОписаниеОшибки());
    КонецПопытки;
    
КонецФункции
```

### Тестирование POST метода в Postman

```
POST http://localhost/hs/demo/СоздатьНовогоКонтрагента?КлючСессии=abc123
Content-Type: application/json

{
    "Наименование": "ООО Ромашка",
    "ИНН": "1234567890",
    "КПП": "123456789"
}
```

## 5. Учебный проект: Система управления задачами

### Проект: Создание HTTP сервиса для управления задачами

#### Шаг 1: Создаем структуру данных

```bsl
// Общий модуль "HTTPСервисЗадачи"
// Флаги: "Глобальный", "Сервер"

// Структура задачи
Структура Задача
    Идентификатор;
    Заголовок;
    Описание;
    Статус;
    Приоритет;
    ДатаСоздания;
    ДатаЗавершения;
    Ответственный;
КонецСтруктуры
```

#### Шаг 2: Создаем обработку для HTTP сервиса

```bsl
// Обработка "HTTPСервисЗадачи"
// Префикс URL: /tasks
```

#### Шаг 3: Реализуем метод GET для получения списка задач

```bsl
&ВместоHTTPСервиса
Функция ПолучитьСписокЗадач(Статус = "", Ответственный = "") Экспорт
    
    Попытка
        Результат = Новый Массив;
        
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ
        |  Задачи.Ссылка,
        |  Задачи.Заголовок,
        |  Задачи.Описание,
        |  Задачи.Статус,
        |  Задачи.Приоритет,
        |  Задачи.ДатаСоздания,
        |  Задачи.ДатаЗавершения,
        |  Задачи.Ответственный
        |ИЗ
        |  Документ.Задачи КАК Задачи
        |ГДЕ
        |  (Задачи.Статус = &Статус ИЛИ &Статус = \"\")
        |  И (Задачи.Ответственный = &Ответственный ИЛИ &Ответственный = \"\")
        |";
        
        Запрос.УстановитьПараметр("Статус", Статус);
        Запрос.УстановитьПараметр("Ответственный", Ответственный);
        
        Выборка = Запрос.Выполнить().Выбрать();
        Пока Выборка.Следующий() Цикл
            Задача = Новый Структура;
            Задача.Вставить("Идентификатор", Выборка.Ссылка.УникальныйИдентификатор());
            Задача.Вставить("Заголовок", Выборка.Заголовок);
            Задача.Вставить("Описание", Выборка.Описание);
            Задача.Вставить("Статус", Выборка.Статус);
            Задача.Вставить("Приоритет", Выборка.Приоритет);
            Задача.Вставить("ДатаСоздания", Выборка.ДатаСоздания);
            Задача.Вставить("ДатаЗавершения", Выборка.ДатаЗавершения);
            Задача.Вставить("Ответственный", Выборка.Ответственный);
            
            Результат.Добавить(Задача);
        КонецЦикла;
        
        Возврат Результат;
        
    Исключение
        Возврат Новый Структура("Ошибка", ОписаниеОшибки());
    КонецПопытки;
    
КонецФункции
```

#### Шаг 4: Реализуем метод GET для получения одной задачи

```bsl
&ВместоHTTPСервиса
Функция ПолучитьЗадачу(Идентификатор) Экспорт
    
    Попытка
        // Поиск задачи по UUID
        ЗадачаОбъект = Документы.Задачи.НайтиПоУникальномуИдентификатору(Идентификатор);
        Если ЗадачаОбъект.Пустая() Тогда
            Возврат Новый Структура("Ошибка", "Задача не найдена");
        КонецЕсли;
        
        // Формирование ответа
        Задача = Новый Структура;
        Задача.Вставить("Идентификатор", ЗадачаОбъект.УникальныйИдентификатор());
        Задача.Вставить("Заголовок", ЗадачаОбъект.Заголовок);
        Задача.Вставить("Описание", ЗадачаОбъект.Описание);
        Задача.Вставить("Статус", ЗадачаОбъект.Статус);
        Задача.Вставить("Приоритет", ЗадачаОбъект.Приоритет);
        Задача.Вставить("ДатаСоздания", ЗадачаОбъект.ДатаСоздания);
        Задача.Вставить("ДатаЗавершения", ЗадачаОбъект.ДатаЗавершения);
        Задача.Вставить("Ответственный", ЗадачаОбъект.Ответственный);
        
        Возврат Задача;
        
    Исключение
        Возврат Новый Структура("Ошибка", ОписаниеОшибки());
    КонецПопытки;
    
КонецФункции
```

#### Шаг 5: Реализуем метод POST для создания новой задачи

```bsl
&ВместоHTTPСервиса
Функция СоздатьЗадачу(ДанныеЗадачи) Экспорт
    
    Попытка
        // Создание новой задачи
        НоваяЗадача = Документы.Задачи.СоздатьДокумент();
        НоваяЗадача.Заголовок = ДанныеЗадачи.Заголовок;
        НоваяЗадача.Описание = ДанныеЗадачи.Описание;
        НоваяЗадача.Статус = "Новая";
        НоваяЗадача.Приоритет = ДанныеЗадачи.Приоритет;
        НоваяЗадача.ДатаСоздания = ТекущаяДата();
        НоваяЗадача.Ответственный = ДанныеЗадачи.Ответственный;
        
        // Запись документа
        НоваяЗадача.Записать();
        
        // Ответ об успехе
        Ответ = Новый Структура;
        Ответ.Вставить("Успех", Истина);
        Ответ.Вставить("Идентификатор", НоваяЗадача.УникальныйИдентификатор());
        Ответ.Вставить("Номер", НоваяЗадача.Номер);
        Ответ.Вставить("Сообщение", "Задача успешно создана");
        
        Возврат Ответ;
        
    Исключение
        Возврат Новый Структура("Успех", Ложь, "Ошибка", ОписаниеОшибки());
    КонецПопытки;
    
КонецФункции
```

#### Шаг 6: Реализуем метод POST для обновления задачи

```bsl
&ВместоHTTPСервиса
Функция ОбновитьЗадачу(Идентификатор, ДанныеЗадачи) Экспорт
    
    Попытка
        // Поиск задачи
        ЗадачаОбъект = Документы.Задачи.НайтиПоУникальномуИдентификатору(Идентификатор);
        Если ЗадачаОбъект.Пустая() Тогда
            Возврат Новый Структура("Успех", Ложь, "Ошибка", "Задача не найдена");
        КонецЕсли;
        
        // Обновление данных
        Если ЗначениеЗаполнено(ДанныеЗадачи.Заголовок) Тогда
            ЗадачаОбъект.Заголовок = ДанныеЗадачи.Заголовок;
        КонецЕсли;
        
        Если ЗначениеЗаполнено(ДанныеЗадачи.Описание) Тогда
            ЗадачаОбъект.Описание = ДанныеЗадачи.Описание;
        КонецЕсли;
        
        Если ЗначениеЗаполнено(ДанныеЗадачи.Статус) Тогда
            ЗадачаОбъект.Статус = ДанныеЗадачи.Статус;
        КонецЕсли;
        
        Если ЗначениеЗаполнено(ДанныеЗадачи.Приоритет) Тогда
            ЗадачаОбъект.Приоритет = ДанныеЗадачи.Приоритет;
        КонецЕсли;
        
        Если ЗначениеЗаполнено(ДанныеЗадачи.Ответственный) Тогда
            ЗадачаОбъект.Ответственный = ДанныеЗадачи.Ответственный;
        КонецЕсли;
        
        // Запись изменений
        ЗадачаОбъект.Записать();
        
        // Ответ об успехе
        Ответ = Новый Структура;
        Ответ.Вставить("Успех", Истина);
        Ответ.Вставить("Сообщение", "Задача успешно обновлена");
        
        Возврат Ответ;
        
    Исключение
        Возврат Новый Структура("Успех", Ложь, "Ошибка", ОписаниеОшибки());
    КонецПопытки;
    
КонецФункции
```

## 6. Система авторизации

### Реализация простой авторизации

```bsl
// В общем модуле "HTTPСервисЗадачи"
Функция АвторизоватьПользователя(Логин, Пароль) Экспорт
    
    Попытка
        // Попытка подключения под пользователем
        Пользователь = ПользователиОрганизации.НайтиПоНаименованию(Логин);
        Если Пользователь = Неопределено Тогда
            Возврат "";
        КонецЕсли;
        
        // В реальной системе здесь должна быть проверка пароля
        // Для демо - генерируем простой ключ
        КлючСессии = Строка(Новый УникальныйИдентификатор);
        
        // Сохраняем ключ в временное хранилище
        Сессии = ПолучитьИзВременногоХранилища("Сессии");
        Если Сессии = Неопределено Тогда
            Сессии = Новый Соответствие;
        КонецЕсли;
        
        Сессии.Вставить(КлючСессии, Логин);
        СохранитьВоВременномХранилище(Сессии, "Сессии");
        
        Возврат КлючСессии;
        
    Исключение
        Возврат "";
    КонецПопытки;
    
КонецФункции

Функция ПроверитьАвторизацию(КлючСессии)
    
    Сессии = ПолучитьИзВременногоХранилища("Сессии");
    Если Сессии = Неопределено Тогда
        Возврат Ложь;
    КонецЕсли;
    
    Возврат Сессии.СодержитКлюч(КлючСессии);
    
КонецФункции
```

### Метод авторизации

```bsl
&ВместоHTTPСервиса
Функция Авторизация(Логин, Пароль) Экспорт
    
    КлючСессии = АвторизоватьПользователя(Логин, Пароль);
    Если КлючСессии = "" Тогда
        Возврат Новый Структура("Успех", Ложь, "Ошибка", "Неверный логин или пароль");
    КонецЕсли;
    
    Возврат Новый Структура("Успех", Истина, "КлючСессии", КлючСессии);
    
КонецФункции
```

## 7. Публикация HTTP сервиса

### В конфигураторе 1С:
1. Откройте обработку "HTTPСервисЗадачи"
2. В свойствах укажите:
   - **Префикс URL**: `/tasks`
   - **Проверка прав**: `Да` (для безопасности)
3. Опубликуйте через "Администрирование" → "Публикация HTTP сервисов"

### URL для доступа:
```
http://localhost/hs/tasks/ИмяМетода
```

## 8. Тестирование в Postman

### Тест 1: Авторизация
```
POST http://localhost/hs/tasks/Авторизация
Content-Type: application/json

{
    "Логин": "Администратор",
    "Пароль": ""
}
```

### Тест 2: Получение списка задач
```
GET http://localhost/hs/tasks/ПолучитьСписокЗадач?КлючСессии=ваш_ключ
```

### Тест 3: Создание новой задачи
```
POST http://localhost/hs/tasks/СоздатьЗадачу?КлючСессии=ваш_ключ
Content-Type: application/json

{
    "Заголовок": "Новая задача",
    "Описание": "Описание тестовой задачи",
    "Приоритет": "Высокий",
    "Ответственный": "Иванов И.И."
}
```

## 9. Обработка ошибок и лучшие практики

### Универсальная обработка ошибок

```bsl
Функция ОбработатьОшибку(ОписаниеОшибки)
    
    // Логирование ошибки
    ЗаписатьЖурналРегистрации("HTTPСервис", УровеньЖурналаРегистрации.Ошибка, , , 
        "Ошибка в HTTP сервисе: " + ОписаниеОшибки);
    
    // Возврат структурированной ошибки
    Возврат Новый Структура("Успех", Ложь, "Ошибка", ОписаниеОшибки);
    
КонецФункции
```

### Проверка входных данных

```bsl
Функция ПроверитьОбязательныеПоля(Данные, ОбязательныеПоля)
    
    Для Каждого Поле Из ОбязательныеПоля Цикл
        Если Не ЗначениеЗаполнено(Данные[Поле]) Тогда
            ВызватьИсключение "Не заполнено обязательное поле: " + Поле;
        КонецЕсли;
    КонецЦикла;
    
КонецФункции
```

Это руководство позволяет создать полноценный HTTP сервис в 1С с методами GET и POST, системой авторизации и обработкой ошибок.
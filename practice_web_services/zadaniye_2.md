# Подробное руководство по созданию веб-сервисов в 1С, возвращающих сложные структуры

## 1. Подготовка конфигурации 1С

### Включение необходимых функциональных опций

1. Откройте конфигуратор
2. Проверьте, что веб-сервисы включены:
   - Меню "Администрирование" → "Параметры публикации"
   - Убедитесь, что стоит галочка "Публиковать веб-сервисы"

## 2. Создание структуры данных для веб-сервисов

### Определение сложных типов данных

```bsl
// Общий модуль "ВебСервисыCommon"
// Установите флаги: "Веб-сервис", "Глобальный"

// Структура для элемента справочника
Структура ЭлементСправочника
    УникальныйИдентификатор;
    Наименование;
    Код;
    ЭтоГруппа;
    Родитель;
    ПомеченНаУдаление;
КонецСтруктуры

// Структура для документа
Структура ЭлементДокумента
    УникальныйИдентификатор;
    Дата;
    Номер;
    ВидОперации;
    Контрагент;
    Сумма;
    Проведен;
КонецСтруктуры

// Структура для табличной части
Структура СтрокаТабличнойЧасти
    Номенклатура;
    Количество;
    Цена;
    Сумма;
КонецСтруктуры
```

## 3. Создание веб-сервиса для работы со справочниками

### Общий модуль "ВебСервисСправочники"

```bsl
// Установите флаги: "Веб-сервис", "Глобальный"

// Функция возвращает элемент справочника по UUID
Функция ПолучитьЭлементСправочника(Идентификатор) Экспорт
    
    Попытка
        ОбъектСправочника = Справочники.Контрагенты.НайтиПоУникальномуИдентификатору(Идентификатор);
        Если ОбъектСправочника.Пустая() Тогда
            ВызватьИсключение "Элемент не найден";
        КонецЕсли;
        
        Возврат СоздатьСтруктуруЭлементаСправочника(ОбъектСправочника);
    Исключение
        ВызватьИсключение ОписаниеОшибки();
    КонецПопытки;
    
КонецФункции

// Функция возвращает список элементов справочника
Функция ПолучитьСписокКонтрагентов(НачалоПериода, КонецПериода, ТолькоАктивные) Экспорт
    
    Результат = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |  Контрагенты.Ссылка,
    |  Контрагенты.Код,
    |  Контрагенты.Наименование,
    |  Контрагенты.ЭтоГруппа,
    |  Контрагенты.Родитель,
    |  Контрагенты.ПомеченНаУдаление
    |ИЗ
    |  Справочник.Контрагенты КАК Контрагенты
    |ГДЕ
    |  Контрагенты.ЭтоГруппа = ЛОЖЬ
    |  И (НЕ &ТолькоАктивные ИЛИ Контрагенты.ПомеченНаУдаление = ЛОЖЬ)
    |";
    
    Запрос.УстановитьПараметр("ТолькоАктивные", ТолькоАктивные);
    
    Выборка = Запрос.Выполнить().Выбрать();
    Пока Выборка.Следующий() Цикл
        СтруктураЭлемента = СоздатьСтруктуруЭлементаСправочника(Выборка.Ссылка);
        Результат.Добавить(СтруктураЭлемента);
    КонецЦикла;
    
    Возврат Результат;
    
КонецФункции

// Вспомогательная функция для формирования структуры элемента справочника
Функция СоздатьСтруктуруЭлементаСправочника(СсылкаНаЭлемент)
    
    Элемент = Новый Структура;
    Элемент.Вставить("УникальныйИдентификатор", СсылкаНаЭлемент.УникальныйИдентификатор());
    Элемент.Вставить("Код", СсылкаНаЭлемент.Код);
    Элемент.Вставить("Наименование", СсылкаНаЭлемент.Наименование);
    Элемент.Вставить("ЭтоГруппа", СсылкаНаЭлемент.ЭтоГруппа);
    Элемент.Вставить("ПомеченНаУдаление", СсылкаНаЭлемент.ПомеченНаУдаление);
    
    Если Не СсылкаНаЭлемент.Родитель.Пустая() Тогда
        Элемент.Вставить("Родитель", СсылкаНаЭлемент.Родитель.УникальныйИдентификатор());
    Иначе
        Элемент.Вставить("Родитель", "");
    КонецЕсли;
    
    Возврат Элемент;
    
КонецФункции
```

## 4. Создание веб-сервиса для работы с документами

### Общий модуль "ВебСервисДокументы"

```bsl
// Установите флаги: "Веб-сервис", "Глобальный"

// Функция возвращает документ с табличными частями
Функция ПолучитьДокументРеализации(ИдентификаторДокумента) Экспорт
    
    Попытка
        ДокументОбъект = Документы.РеализацияТоваровУслуг.НайтиПоУникальномуИдентификатору(ИдентификаторДокумента);
        Если ДокументОбъект.Пустая() Тогда
            ВызватьИсключение "Документ не найден";
        КонецЕсли;
        
        Возврат СоздатьСтруктуруДокумента(ДокументОбъект);
    Исключение
        ВызватьИсключение ОписаниеОшибки();
    КонецПопытки;
    
КонецФункции

// Функция возвращает список документов за период
Функция ПолучитьДокументыЗаПериод(ДатаНачала, ДатаОкончания, ВидДокумента) Экспорт
    
    Результат = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |  Документы.Ссылка
    |ИЗ
    |  Документ." + ВидДокумента + " КАК Документы
    |ГДЕ
    |  Документы.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
    |";
    
    Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
    
    Выборка = Запрос.Выполнить().Выбрать();
    Пока Выборка.Следующий() Цикл
        ДокументОбъект = Выборка.Ссылка.ПолучитьОбъект();
        СтруктураДокумента = СоздатьСтруктуруДокумента(ДокументОбъект);
        Результат.Добавить(StруктураДокумента);
    КонецЦикла;
    
    Возврат Результат;
    
КонецФункции

// Создание сложной структуры документа
Функция СоздатьСтруктуруДокумента(ДокументОбъект)
    
    ДокументСтруктура = Новый Структура;
    
    // Основные реквизиты
    ДокументСтруктура.Вставить("УникальныйИдентификатор", ДокументОбъект.УникальныйИдентификатор());
    ДокументСтруктура.Вставить("Дата", ДокументОбъект.Дата);
    ДокументСтруктура.Вставить("Номер", ДокументОбъект.Номер);
    ДокументСтруктура.Вставить("ВидОперации", ДокументОбъект.ВидОперации);
    ДокументСтруктура.Вставить("Проведен", ДокументОбъект.Проведен);
    ДокументСтруктура.Вставить("Сумма", ДокументОбъект.Сумма);
    
    // Контрагент
    Если Не ДокументОбъект.Контрагент.Пустая() Тогда
        ДокументСтруктура.Вставить("Контрагент", СоздатьСтруктуруЭлементаСправочника(ДокументОбъект.Контрагент));
    КонецЕсли;
    
    // Склад
    Если Не ДокументОбъект.Склад.Пустая() Тогда
        ДокументСтруктура.Вставить("Склад", СоздатьСтруктуруЭлементаСправочника(ДокументОбъект.Склад));
    КонецЕсли;
    
    // Табличные части
    ДокументСтруктура.Вставить("Товары", ПолучитьТабличнуюЧасть(ДокументОбъект.Товары));
    ДокументСтруктура.Вставить("Услуги", ПолучитьТабличнуюЧасть(ДокументОбъект.Услуги));
    
    Возврат ДокументСтруктура;
    
КонецФункции

// Обработка табличной части
Функция ПолучитьТабличнуюЧасть(ТабличнаяЧасть)
    
    Результат = Новый Массив;
    
    Для Каждого Строка Из ТабличнаяЧасть Цикл
        СтрокаСтруктура = Новый Структура;
        
        // Основные поля строки
        СтрокаСтруктура.Вставить("Номенклатура", СоздатьСтруктуруЭлементаСправочника(Строка.Номенклатура));
        СтрокаСтруктура.Вставить("Количество", Строка.Количество);
        СтрокаСтруктура.Вставить("Цена", Строка.Цена);
        СтрокаСтруктура.Вставить("Сумма", Строка.Сумма);
        
        // Дополнительные поля
        Если ЗначениеЗаполнено(Строка.ЕдиницаИзмерения) Тогда
            СтрокаСтруктура.Вставить("ЕдиницаИзмерения", СоздатьСтруктуруЭлементаСправочника(Строка.ЕдиницаИзмерения));
        КонецЕсли;
        
        Если ЗначениеЗаполнено(Строка.СтавкаНДС) Тогда
            СтрокаСтруктура.Вставить("СтавкаНДС", Строка.СтавкаНДС);
        КонецЕсли;
        
        Результат.Добавить(СтрокаСтруктура);
    КонецЦикла;
    
    Возврат Результат;
    
КонецФункции
```

## 5. Создание комплексного веб-сервиса с отчетными данными

### Общий модуль "ВебСервисОтчеты"

```bsl
// Установите флаги: "Веб-сервис", "Глобальный"

// Комплексная структура отчета по продажам
Функция ПолучитьОтчетПоПродажам(ДатаНачала, ДатаОкончания) Экспорт
    
    Результат = Новый Структура;
    
    // Основная информация
    Результат.Вставить("ПериодОт", ДатаНачала);
    Результат.Вставить("ПериодДо", ДатаОкончания);
    Результат.Вставить("ДатаФормирования", ТекущаяДата());
    
    // Данные по документам
    Результат.Вставить("Документы", ПолучитьДокументыЗаПериод(ДатаНачала, ДатаОкончания, "РеализацияТоваровУслуг"));
    
    // Сводные данные
    Результат.Вставить("Итоги", РассчитатьИтогиПоПродажам(ДатаНачала, ДатаОкончания));
    
    // Топ контрагентов
    Результат.Вставить("ТопКонтрагенты", ПолучитьТопКонтрагентов(ДатаНачала, ДатаОкончания, 10));
    
    Возврат Результат;
    
КонецФункции

// Расчет итоговых показателей
Функция РассчитатьИтогиПоПродажам(ДатаНачала, ДатаОкончания)
    
    Итоги = Новый Структура;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |  Реализация.Ссылка,
    |  Реализация.Сумма
    |ИЗ
    |  Документ.РеализацияТоваровУслуг КАК Реализация
    |ГДЕ
    |  Реализация.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
    |  И Реализация.Проведен = ИСТИНА
    |";
    
    Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
    
    Выборка = Запрос.Выполнить().Выбрать();
    
    ОбщаяСумма = 0;
    КоличествоДокументов = 0;
    
    Пока Выборка.Следующий() Цикл
        ОбщаяСумма = ОбщаяСумма + Выборка.Сумма;
        КоличествоДокументов = КоличествоДокументов + 1;
    КонецЦикла;
    
    Итоги.Вставить("ОбщаяСумма", ОбщаяСумма);
    Итоги.Вставить("КоличествоДокументов", КоличествоДокументов);
    Итоги.Вставить("СреднийЧек", ?(КоличествоДокументов > 0, ОбщаяСумма / КоличествоДокументов, 0));
    
    Возврат Итоги;
    
КонецФункции

// Получение топа контрагентов
Функция ПолучитьТопКонтрагентов(ДатаНачала, ДатаОкончания, КоличествоСтрок)
    
    Результат = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |  Реализация.Контрагент,
    |  SUM(Реализация.Сумма) КАК Сумма,
    |  КОЛИЧЕСТВО(Реализация.Ссылка) КАК КоличествоДокументов
    |ИЗ
    |  Документ.РеализацияТоваровУслуг КАК Реализация
    |ГДЕ
    |  Реализация.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
    |  И Реализация.Проведен = ИСТИНА
    |СГРУППИРОВАТЬ ПО
    |  Реализация.Контрагент
    |УПОРЯДОЧИТЬ ПО
    |  Сумма УБЫВ
    |";
    
    Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
    
    Выборка = Запрос.Выполнить().Выбрать();
    
    Счетчик = 0;
    Пока Выборка.Следующий() И Счетчик < КоличествоСтрок Цикл
        КонтрагентСтруктура = Новый Структура;
        КонтрагентСтруктура.Вставить("Контрагент", СоздатьСтруктуруЭлементаСправочника(Выборка.Контрагент));
        КонтрагентСтруктура.Вставить("СуммаПродаж", Выборка.Сумма);
        КонтрагентСтруктура.Вставить("КоличествоДокументов", Выборка.КоличествоДокументов);
        
        Результат.Добавить(КонтрагентСтруктура);
        Счетчик = Счетчик + 1;
    КонецЦикла;
    
    Возврат Результат;
    
КонецФункции
```

## 6. Публикация веб-сервисов

### Настройка публикации

1. В конфигураторе: "Администрирование" → "Публикация веб-сервисов"
2. Выберите каталог публикации (например, /ws)
3. Отметьте созданные общие модули для публикации
4. Укажите базовый URL (например, http://localhost/test/ws)



## 7. Тестирование веб-сервисов через Postman

### Пример SOAP запроса для получения документа

```xml
POST /test/ws/ВебСервисДокументы HTTP/1.1
Host: localhost
Content-Type: text/xml; charset=utf-8
SOAPAction: "http://tempuri.org/ВебСервисДокументы#ПолучитьДокументРеализации"

<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/">
    <soap:Body>
        <ПолучитьДокументРеализации xmlns="http://tempuri.org/">
            <ИдентификаторДокумента>a1234567-b8c9-0123-4567-890abcdef012</ИдентификаторДокумента>
        </ПолучитьДокументРеализации>
    </soap:Body>
</soap:Envelope>
```

### Пример SOAP запроса для получения отчета

```xml
POST /test/ws/ВебСервисОтчеты HTTP/1.1
Host: localhost
Content-Type: text/xml; charset=utf-8
SOAPAction: "http://tempuri.org/ВебСервисОтчеты#ПолучитьОтчетПоПродажам"

<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/">
    <soap:Body>
        <ПолучитьОтчетПоПродажам xmlns="http://tempuri.org/">
            <ДатаНачала>2024-01-01</ДатаНачала>
            <ДатаОкончания>2024-01-31</ДатаОкончания>
        </ПолучитьОтчетПоПродажам>
    </soap:Body>
</soap:Envelope>
```

## 8. Обработка ошибок и лучшие практики

### Добавление обработки ошибок

```bsl
// Универсальная функция-обертка для веб-сервисов
Функция ВыполнитьВебСервис(ИмяФункции, Параметры = Неопределено)
    
    Попытка
        // Логирование вызова
        ЗаписатьЖурналРегистрации("ВебСервис", УровеньЖурналаРегистрации.Информация, , , 
            "Вызов веб-сервиса: " + ИмяФункции);
        
        // Выполнение функции
        Если Параметры = Неопределено Тогда
            Возврат Вычислить(ИмяФункция + "()");
        Иначе
            Возврат Вычислить(ИмяФункция + "(" + Параметры + ")");
        КонецЕсли;
        
    Исключение
        // Логирование ошибки
        ЗаписатьЖурналРегистрации("ВебСервис", УровеньЖурналаРегистрации.Ошибка, , , 
            "Ошибка в веб-сервисе " + ИмяФункции + ": " + ОписаниеОшибки());
        
        ВызватьИсключение "Ошибка выполнения веб-сервиса: " + ОписаниеОшибки();
    КонецПопытки;
    
КонецФункции
```

### Рекомендации по производительности

1. Используйте пагинацию для больших списков
2. Кэшируйте часто запрашиваемые данные
3. Ограничивайте размер возвращаемых данных
4. Используйте параметры фильтрации

Это руководство позволяет создавать веб-сервисы в 1С, которые возвращают сложные структуры данных, включая справочники, документы с табличными частями и отчетные формы.